# SQLç”Ÿæˆåæ€æ¨¡å¼å®žéªŒ

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®å®žçŽ°äº†**åæ€è®¾è®¡æ¨¡å¼**ï¼ˆReflection Patternï¼‰ï¼Œç”¨äºŽæ”¹è¿›è‡ªç„¶è¯­è¨€åˆ°SQLæŸ¥è¯¢çš„è½¬æ¢ã€‚é€šè¿‡è®©AIæ¨¡åž‹åæ€å’Œæ”¹è¿›è‡ªå·±ç”Ÿæˆçš„SQLæŸ¥è¯¢ï¼Œæ˜¾è‘—æé«˜æŸ¥è¯¢çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚

## æ ¸å¿ƒç‰¹æ€§

- ðŸ§  **æ™ºèƒ½SQLç”Ÿæˆ**ï¼šå°†è‡ªç„¶è¯­è¨€é—®é¢˜è½¬æ¢ä¸ºSQLæŸ¥è¯¢
- ðŸ”„ **åæ€æ”¹è¿›**ï¼šåŸºäºŽæ‰§è¡Œç»“æžœè‡ªåŠ¨ä¼˜åŒ–SQLæŸ¥è¯¢
- âœ… **å¤–éƒ¨åé¦ˆ**ï¼šåˆ©ç”¨å®žé™…æŸ¥è¯¢ç»“æžœå‘çŽ°å¹¶ä¿®æ­£é”™è¯¯
- ðŸ“Š **äº‹ä»¶æº¯æºæ•°æ®åº“**ï¼šä½¿ç”¨transactionsè¡¨æ¨¡æ‹ŸçœŸå®žä¸šåŠ¡åœºæ™¯

## æ–‡ä»¶ç»“æž„

```
.
â”œâ”€â”€ main.py                 # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ sql_workflow.py         # æ ¸å¿ƒå·¥ä½œæµå®žçŽ°
â”œâ”€â”€ utils.py                # è¾…åŠ©å·¥å…·å‡½æ•°
â”œâ”€â”€ requirements.txt        # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ .env.example            # çŽ¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜Ž
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®çŽ¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å…¥ä½ çš„ API å¯†é’¥ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```
GOOGLE_API_KEY=your_google_api_key_here
```

æˆ–ä½¿ç”¨ OpenAIï¼š

```
OPENAI_API_KEY=your_openai_api_key_here
```

### 3. è¿è¡Œç¨‹åº

```bash
python main.py
```

## å·¥ä½œæµç¨‹

### å®Œæ•´åæ€æµç¨‹ï¼š

1. **æå–æ•°æ®åº“æž¶æž„** - èŽ·å–è¡¨ç»“æž„ä¿¡æ¯
2. **ç”ŸæˆSQL (V1)** - ä½¿ç”¨LLMæ ¹æ®é—®é¢˜ç”Ÿæˆåˆå§‹SQL
3. **æ‰§è¡ŒV1** - è¿è¡ŒSQLå¹¶èŽ·å–ç»“æžœ
4. **åæ€V1** - åˆ†æžæ‰§è¡Œç»“æžœï¼Œè¯†åˆ«é—®é¢˜
5. **ç”ŸæˆSQL (V2)** - åŸºäºŽåé¦ˆç”Ÿæˆæ”¹è¿›ç‰ˆSQL
6. **æ‰§è¡ŒV2** - è¿è¡Œæ”¹è¿›åŽçš„SQLï¼Œå¾—åˆ°æœ€ç»ˆç­”æ¡ˆ

## æ ¸å¿ƒå‡½æ•°è¯´æ˜Ž

### `generate_sql(question, schema, model)`

ç”Ÿæˆåˆå§‹SQLæŸ¥è¯¢ï¼ˆV1ç‰ˆæœ¬ï¼‰

- **è¾“å…¥**ï¼šè‡ªç„¶è¯­è¨€é—®é¢˜ã€æ•°æ®åº“æž¶æž„ã€LLMæ¨¡åž‹
- **è¾“å‡º**ï¼šSQLæŸ¥è¯¢å­—ç¬¦ä¸²

### `refine_sql_external_feedback(question, sql_query, df_feedback, schema, model)`

åŸºäºŽæ‰§è¡Œç»“æžœè¿›è¡Œåæ€æ”¹è¿›ï¼ˆâ­æ ¸å¿ƒï¼‰

- **è¾“å…¥**ï¼šé—®é¢˜ã€åŽŸå§‹SQLã€æ‰§è¡Œç»“æžœDataFrameã€æž¶æž„ã€æ¨¡åž‹
- **è¾“å‡º**ï¼š(åé¦ˆæ–‡æœ¬, æ”¹è¿›åŽçš„SQL V2)

### `run_workflow(db_path, question, generation_model, evaluation_model)`

ç«¯åˆ°ç«¯è‡ªåŠ¨åŒ–å·¥ä½œæµ

- **è¾“å…¥**ï¼šæ•°æ®åº“è·¯å¾„ã€é—®é¢˜ã€ç”Ÿæˆæ¨¡åž‹ã€è¯„ä¼°æ¨¡åž‹
- **è¾“å‡º**ï¼šåŒ…å«æ‰€æœ‰äº§ç‰©çš„å­—å…¸

## ç¤ºä¾‹

### é—®é¢˜
"å“ªç§é¢œè‰²çš„äº§å“æ€»é”€å”®é¢æœ€é«˜ï¼Ÿ"

### V1é—®é¢˜
```sql
SELECT color, SUM(qty_delta * unit_price) as total_sales
FROM transactions
WHERE action = 'sale'
GROUP BY color
ORDER BY total_sales DESC
LIMIT 1
```
âŒ ç»“æžœï¼š`total_sales = -190571.46`ï¼ˆè´Ÿå€¼ï¼ï¼‰

### V2æ”¹è¿›
```sql
SELECT color, SUM(ABS(qty_delta) * unit_price) as total_sales
FROM transactions
WHERE action = 'sale'
GROUP BY color
ORDER BY total_sales DESC
LIMIT 1
```
âœ… ç»“æžœï¼š`total_sales = 190571.46`ï¼ˆæ­£ç¡®ï¼ï¼‰

## å…³é”®å­¦ä¹ ç‚¹

### ä¸ºä»€ä¹ˆéœ€è¦åæ€ï¼Ÿ

1. **è¯­ä¹‰é”™è¯¯éš¾ä»¥å‘çŽ°**ï¼šSQLåœ¨è¯­æ³•ä¸Šæ­£ç¡®ï¼Œä½†é€»è¾‘ä¸Šæœ‰é—®é¢˜
2. **æ•°æ®ç‰¹æ€§å½±å“ç»“æžœ**ï¼šé”€å”®æ—¶`qty_delta`ä¸ºè´Ÿæ•°ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
3. **å¤–éƒ¨åé¦ˆè‡³å…³é‡è¦**ï¼šä»…çœ‹SQLä»£ç æ— æ³•å‘çŽ°æ‰§è¡Œç»“æžœçš„å¼‚å¸¸

### åæ€æ¨¡å¼çš„ä»·å€¼

- ðŸŽ¯ **è‡ªåŠ¨å‘çŽ°é—®é¢˜**ï¼šé€šè¿‡æ‰§è¡Œç»“æžœè¯†åˆ«é”™è¯¯
- ðŸ”§ **è‡ªåŠ¨ä¿®æ­£**ï¼šç”Ÿæˆæ”¹è¿›ç‰ˆæŸ¥è¯¢
- ðŸ“ˆ **æé«˜å‡†ç¡®æ€§**ï¼šè¿­ä»£ä¼˜åŒ–ï¼Œå¾—åˆ°æ›´å¥½çš„ç»“æžœ

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹é—®é¢˜

ç¼–è¾‘ `main.py` ä¸­çš„ `question` å˜é‡ï¼š

```python
question = "å“ªä¸ªå“ç‰Œçš„æ€»åº“å­˜æœ€å¤šï¼Ÿ"
```

### æ›´æ¢æ¨¡åž‹

```python
# æŽ¨èï¼šGoogle Geminiï¼ˆé»˜è®¤ï¼‰
generation_model = "google:gemini-2.0-flash-exp"               # å¿«é€Ÿç”Ÿæˆ
evaluation_model = "google:gemini-2.0-flash-thinking-exp-1219" # é«˜è´¨é‡åæ€

# æˆ–ä½¿ç”¨ OpenAI
generation_model = "openai:gpt-4o-mini"   # å¿«é€Ÿä¸”ç»æµŽ
evaluation_model = "openai:gpt-4o"        # æ›´å¼ºçš„æŽ¨ç†èƒ½åŠ›

# æˆ–ä½¿ç”¨ Anthropic Claude
generation_model = "anthropic:claude-3-5-sonnet-20241022"
evaluation_model = "anthropic:claude-3-5-sonnet-20241022"
```

æ”¯æŒçš„æ¨¡åž‹æä¾›å•†ï¼š

**Google Gemini**ï¼ˆæŽ¨èï¼‰ï¼š
- `google:gemini-2.0-flash-exp` - æœ€æ–°å¿«é€Ÿæ¨¡åž‹
- `google:gemini-2.0-flash-thinking-exp-1219` - é«˜çº§æŽ¨ç†æ¨¡åž‹
- `google:gemini-1.5-pro` - é«˜æ€§èƒ½æ¨¡åž‹
- `google:gemini-1.5-flash` - å¿«é€Ÿæ¨¡åž‹

**OpenAI**ï¼š
- `openai:gpt-4o` - æœ€æ–°æ——èˆ°æ¨¡åž‹
- `openai:gpt-4o-mini` - å¿«é€Ÿç»æµŽæ¨¡åž‹
- `openai:gpt-4-turbo` - é«˜æ€§èƒ½æ¨¡åž‹

**Anthropic Claude**ï¼š
- `anthropic:claude-3-5-sonnet-20241022` - é«˜è´¨é‡æ¨¡åž‹

## æ•°æ®åº“è¯´æ˜Ž

### transactions è¡¨ç»“æž„

| å­—æ®µ | ç±»åž‹ | è¯´æ˜Ž |
|------|------|------|
| id | INTEGER | äº‹ä»¶å”¯ä¸€ID |
| product_id | INTEGER | äº§å“ID |
| product_name | TEXT | äº§å“åç§° |
| brand | TEXT | å“ç‰Œ |
| category | TEXT | ç±»åˆ« |
| color | TEXT | é¢œè‰² |
| action | TEXT | äº‹ä»¶ç±»åž‹ï¼ˆinsert/restock/sale/price_updateï¼‰ |
| qty_delta | INTEGER | åº“å­˜å˜åŒ–ï¼ˆ+ä¸ºå…¥åº“ï¼Œ-ä¸ºé”€å”®ï¼‰ |
| unit_price | REAL | å•ä»· |
| notes | TEXT | å¤‡æ³¨ |
| ts | DATETIME | æ—¶é—´æˆ³ |

### äº‹ä»¶æº¯æºæ¨¡å¼

- **insert**ï¼šåˆå§‹å…¥åº“ï¼ˆqty_delta > 0ï¼‰
- **restock**ï¼šè¡¥è´§ï¼ˆqty_delta > 0ï¼‰
- **sale**ï¼šé”€å”®ï¼ˆqty_delta < 0ï¼Œè´Ÿæ•°ï¼ï¼‰
- **price_update**ï¼šä»·æ ¼æ›´æ–°ï¼ˆqty_delta = 0ï¼‰

## æ•…éšœæŽ’é™¤

### é—®é¢˜ï¼šAPIè°ƒç”¨å¤±è´¥

æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®ã€‚

### é—®é¢˜ï¼šå¯¼å…¥é”™è¯¯

ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å·²å®‰è£…ï¼š
```bash
pip install -r requirements.txt
```

### é—®é¢˜ï¼šæ•°æ®åº“ä¸å­˜åœ¨

ç¨‹åºä¼šè‡ªåŠ¨åˆ›å»º `products.db`ï¼Œå¦‚æžœåˆ é™¤åŽé‡æ–°è¿è¡Œ `main.py` å³å¯ã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ ä½¿ç”¨ã€‚

## è´¡çŒ®

æ¬¢è¿Žæäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼
